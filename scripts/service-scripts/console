#!/bin/bash
########################################################################
# Begin console
#
# Description : Sets keymap and screen font
#
# Authors     : DJ Lucas - dj@linuxfromscratch.org
#
# Version     : initd 0.1.0
#
########################################################################

# Source console configuration
[ -r /etc/initd/sysconfig/console.conf ] && . /etc/initd/sysconfig/console.conf

failed=0

# See if we need to do anything
if [ -z "${KEYMAP}" ] && [ -z "${KEYMAP_CORRECTIONS}" ] &&
   [ -z "${FONT}" ] && [ -z "${LEGACY_CHARSET}" ] &&
   [ "${UNICODE}" != "true" ]; then
   echo "No console configuration, skipping"
   exit 0
fi

echo "Setting up Linux console"

# Figure out if a framebuffer console is used
[ -d /sys/class/graphics/fbcon ] && use_fb=1 || use_fb=0

# Figure out the command to set the console into the desired mode
if [ "${UNICODE}" = "true" ]; then
   MODE_COMMAND="echo -en '\033%G' && kbd_mode -u"
else
   MODE_COMMAND="echo -en '\033%@\033(K' && kbd_mode -a"
fi

# On framebuffer consoles, font has to be set for each vt in UTF-8 mode
if [ "${use_fb}" = "1" ] && [ -n "${FONT}" ]; then
   MODE_COMMAND="${MODE_COMMAND} && setfont ${FONT}"
fi

# Apply mode command to all active consoles
for TTY in /dev/tty[0-9]*; do
   [ -c "${TTY}" ] || continue
   openvt -f -w -c ${TTY#/dev/tty} -- /bin/sh -c "${MODE_COMMAND}" || failed=1
done

# Set the font (if not already set above)
if [ "${use_fb}" != "1" ] && [ -n "${FONT}" ]; then
   echo "Setting font: ${FONT}"
   setfont ${FONT} || failed=1
fi

# Set the keymap
if [ -n "${KEYMAP}" ]; then
   echo "Loading keymap: ${KEYMAP}"
   loadkeys ${KEYMAP} >/dev/null 2>&1 || failed=1
fi

# Apply keymap corrections
if [ -n "${KEYMAP_CORRECTIONS}" ]; then
   echo "Applying keymap corrections: ${KEYMAP_CORRECTIONS}"
   loadkeys ${KEYMAP_CORRECTIONS} >/dev/null 2>&1 || failed=1
fi

# Convert the keymap from legacy charset to UTF-8
if [ -n "${LEGACY_CHARSET}" ]; then
   echo "Converting keymap from ${LEGACY_CHARSET} to UTF-8"
   dumpkeys -c "${LEGACY_CHARSET}" | loadkeys -u >/dev/null 2>&1 || failed=1
fi

if [ ${failed} -eq 0 ]; then
   echo "Console setup complete"
else
   echo "WARNING: Some console setup steps failed"
fi

exit ${failed}

# End console
