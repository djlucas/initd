#!/bin/bash
########################################################################
# Begin /lib/initd/network-services/dhcpcd
#
# Description : DHCP configuration using dhcpcd
#
# Authors     : DJ Lucas - dj@linuxfromscratch.org
#
# Version     : initd 0.1.0
#
########################################################################

IFACE=$1
ACTION=$2

# Config already sourced by network-configure and exported

case "${ACTION}" in
   up)
      # Check if dhcpcd is available
      if ! command -v dhcpcd >/dev/null 2>&1; then
         echo "ERROR: dhcpcd not found in PATH"
         exit 1
      fi

      # Bring interface up first
      if ! ip link show ${IFACE} >/dev/null 2>&1; then
         echo "ERROR: Interface ${IFACE} does not exist"
         exit 1
      fi

      echo "Bringing up interface ${IFACE}"
      ip link set ${IFACE} up

      # Start dhcpcd
      echo "Starting dhcpcd on ${IFACE}"
      dhcpcd ${DHCP_OPTIONS} ${IFACE}

      if [ $? -ne 0 ]; then
         echo "ERROR: Failed to start dhcpcd"
         exit 1
      fi

      echo "DHCP configuration started for ${IFACE}"
      ;;

   down)
      # Check if dhcpcd is running for this interface
      if pidof dhcpcd >/dev/null 2>&1; then
         echo "Stopping dhcpcd on ${IFACE}"
         dhcpcd -k ${IFACE}
      fi

      # Bring interface down
      echo "Bringing down interface ${IFACE}"
      ip link set ${IFACE} down

      echo "Interface ${IFACE} taken down successfully"
      ;;

   *)
      echo "Usage: $0 <interface> {up|down}"
      exit 1
      ;;
esac

exit 0

# End /lib/initd/network-services/dhcpcd
